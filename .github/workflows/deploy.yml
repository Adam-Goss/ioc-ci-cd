name: Deploy IOCs

on:
  push:
    branches: [main]
    paths:
      - 'iocs/indicators.txt'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine newly merged IOCs
        id: diff
        run: |
          # Diff against previous commit to find what the merge added
          # Write to workspace so the Docker container can access it
          git diff HEAD~1..HEAD -- iocs/indicators.txt \
            | grep '^+' | grep -v '^+++' | sed 's/^+//' > new_iocs.txt || true

          count=$(wc -l < new_iocs.txt || echo "0")
          echo "count=$count" >> "$GITHUB_OUTPUT"

          echo "Found $count newly merged IOC lines"
          cat new_iocs.txt

      - name: Skip if no new IOCs
        if: steps.diff.outputs.count == '0'
        run: |
          echo "No new IOCs to deploy."
          exit 0

      - name: Inventory new IOCs (Phase 1 — enrich and record)
        if: steps.diff.outputs.count != '0'
        uses: ./
        with:
          command: inventory
          ioc_file: new_iocs.txt
          enrichment_sources: ${{ vars.ENRICHMENT_SOURCES || 'virustotal,abuseipdb,otx' }}
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}

      - name: Hunt for IOCs (Phase 2 — search security platforms)
        if: steps.diff.outputs.count != '0'
        uses: ./
        with:
          command: publish
          publishers: ${{ vars.PUBLISHERS || 'splunk,elastic' }}
          enrichment_sources: ${{ vars.ENRICHMENT_SOURCES || 'virustotal,abuseipdb,otx' }}
          max_ioc_age_days: ${{ vars.MAX_IOC_AGE_DAYS || '30' }}
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}
          SPLUNK_URL: ${{ secrets.SPLUNK_URL }}
          SPLUNK_TOKEN: ${{ secrets.SPLUNK_TOKEN }}
          SPLUNK_INDEX: ${{ vars.SPLUNK_INDEX || 'main' }}
          SPLUNK_MIN_CONFIDENCE_LEVEL: ${{ vars.SPLUNK_MIN_CONFIDENCE_LEVEL || 'low' }}
          ELASTIC_URL: ${{ secrets.ELASTIC_URL }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
          ELASTIC_INDEX: ${{ vars.ELASTIC_INDEX || '*' }}
          ELASTIC_VERIFY_SSL: ${{ vars.ELASTIC_VERIFY_SSL || 'true' }}
          ELASTIC_MIN_CONFIDENCE_LEVEL: ${{ vars.ELASTIC_MIN_CONFIDENCE_LEVEL || 'low' }}

      - name: Clear indicators.txt and commit master inventory
        if: steps.diff.outputs.count != '0'
        run: |
          # Clear the indicators.txt file
          cat > iocs/indicators.txt << 'EOF'
          # IOC CI/CD Pipeline - New Indicators
          #
          # Add your IOCs below (one per line, no type prefixes - auto-detected)
          # Supported types: IPv4, Domain, URL, MD5, SHA1, SHA256
          #
          # Lines starting with # are comments
          # Empty lines are ignored

          # Add your IOCs here:
          EOF

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit changes
          git add iocs/indicators.txt iocs/master-indicators.csv
          git commit -m "chore: clear indicators.txt and update master inventory [skip ci]" || echo "No changes to commit"
          git push

      - name: Log hunt summary
        if: steps.diff.outputs.count != '0'
        run: |
          echo "Hunt complete"
          echo "IOCs processed: ${{ steps.diff.outputs.count }}"
          echo "Commit: ${{ github.sha }}"
          echo "Master inventory updated and indicators.txt cleared"
