name: Deploy IOCs

on:
  push:
    branches: [main]
    paths:
      - 'iocs/indicators.txt'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine newly merged IOCs
        id: diff
        run: |
          # Diff against previous commit to find what the merge added
          # Write to workspace so the Docker container can access it
          git diff HEAD~1..HEAD -- iocs/indicators.txt \
            | grep '^+' | grep -v '^+++' | sed 's/^+//' > new_iocs.txt || true

          count=$(wc -l < new_iocs.txt || echo "0")
          echo "count=$count" >> "$GITHUB_OUTPUT"

          echo "Found $count newly merged IOC lines"
          cat new_iocs.txt

      - name: Skip if no new IOCs
        if: steps.diff.outputs.count == '0'
        run: |
          echo "No new IOCs to deploy."
          exit 0

      - name: Inventory new IOCs (Phase 1)
        if: steps.diff.outputs.count != '0'
        uses: ./
        with:
          command: inventory
          ioc_file: new_iocs.txt
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}

      - name: Deploy to MISP and OpenCTI (Phase 2)
        if: steps.diff.outputs.count != '0'
        uses: ./
        with:
          command: publish
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}
          MISP_URL: ${{ secrets.MISP_URL }}
          MISP_API_KEY: ${{ secrets.MISP_API_KEY }}
          MISP_VERIFY_SSL: ${{ vars.MISP_VERIFY_SSL || 'true' }}
          MISP_MIN_CONFIDENCE_LEVEL: ${{ vars.MISP_MIN_CONFIDENCE_LEVEL || 'medium' }}
          OPENCTI_URL: ${{ secrets.OPENCTI_URL }}
          OPENCTI_TOKEN: ${{ secrets.OPENCTI_TOKEN }}
          OPENCTI_MIN_CONFIDENCE_LEVEL: ${{ vars.OPENCTI_MIN_CONFIDENCE_LEVEL || 'high' }}

      - name: Clear indicators.txt and commit master inventory
        if: steps.diff.outputs.count != '0'
        run: |
          # Clear the indicators.txt file
          cat > iocs/indicators.txt << 'EOF'
          # IOC CI/CD Pipeline - New Indicators
          #
          # Add your IOCs below (one per line, no type prefixes - auto-detected)
          # Supported types: IPv4, Domain, URL, MD5, SHA1, SHA256
          #
          # Lines starting with # are comments
          # Empty lines are ignored

          # Add your IOCs here:
          EOF

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit changes
          git add iocs/indicators.txt iocs/master-indicators.csv
          git commit -m "chore: clear indicators.txt and update master inventory [skip ci]" || echo "No changes to commit"
          git push

      - name: Log deployment summary
        if: steps.diff.outputs.count != '0'
        run: |
          echo "Deployment complete"
          echo "IOCs processed: ${{ steps.diff.outputs.count }}"
          echo "Commit: ${{ github.sha }}"
          echo "Master inventory updated and indicators.txt cleared"
